<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Melway Road Change Timeline</title>

    <!-- Bootstrap -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />

    <!-- Leaflet -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
    />

    <style>
      #map {
        width: 100%;
        height: 700px;
      }

      /* 圖例 Legend */
      .legend {
        background: white;
        padding: 10px 15px;
        line-height: 18px;
        color: #555;
        border-radius: 6px;
        box-shadow: 0 0 8px rgba(0, 0, 0, 0.25);
      }
      .legend i {
        width: 20px;
        height: 10px;
        float: left;
        margin-right: 10px;
        opacity: 0.9;
      }
    </style>
  </head>

  <body>
    <div class="container-fluid mt-3">
      <!-- 地圖 -->
      <div class="row">
        <div class="col justify-content-center align-items-center">
          <div id="map"></div>
        </div>
      </div>

      <!-- 年份按鈕 -->
      <div class="row justify-content-center mt-4">
        <div class="col-auto">
          <div class="btn-group" role="group" id="yearButtons"></div>
        </div>
      </div>

      <!-- 顏色說明區 -->
      <div class="row justify-content-center mt-4">
        <div class="col-10 col-md-6">
          <div class="card p-3 shadow-sm">
            <h5>Road Type Explanation</h5>
            <ul style="list-style: none; padding-left: 0">
              <li>
                <span style="color: #ff0000; font-weight: bold">■</span>
                Disappeared – Road existed historically but not in the later
                year.
              </li>
              <li>
                <span style="color: #007bff; font-weight: bold">■</span> Added –
                Road that appears in the later year but not in the earlier one.
              </li>
              <li>
                <span style="color: #40be7f; font-weight: bold">■</span>
                Persisted – Road exists in both years.
              </li>
              <li>
                <span style="color: #666666; font-weight: bold">■</span>
                Historical All – All historical roads detected from the old
                Melway map
                <span style="color: #999"
                  >(may include imperfect or noisy extraction)</span
                >.
              </li>
            </ul>

            <div class="form-check mt-2">
              <input
                class="form-check-input"
                type="checkbox"
                id="toggleHistorical"
                checked
              />
              <label class="form-check-label" for="toggleHistorical">
                Show Historical (Gray) Roads
              </label>
            </div>
          </div>
        </div>
      </div>

      <div class="mb-5"></div>
    </div>

    <!-- JS Dependencies -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>

    <script>
      /* ===============================
   年份 & 區塊設定
================================== */

      const years = ["2001", "2006", "2011", "2020"];
      const blocks = ["m003", "m004", "m005", "m006", "m007"];

      const layerColors = {
        added: "#007bff",
        disappeared: "#ff0000",
        persisted: "#40be7f",
        historical_all: "#666666",
      };

      /* ===============================
   初始化地圖
================================== */

      var map = L.map("map").setView([-37.75, 145.0], 12);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19,
      }).addTo(map);

      let layerGroups = {
        added: [],
        disappeared: [],
        persisted: [],
        historical_all: [],
      };

      function clearAllLayers() {
        for (let type in layerGroups) {
          layerGroups[type].forEach((layer) => map.removeLayer(layer));
          layerGroups[type] = [];
        }
      }

      /* ===============================
   載入 GeoJSON
================================== */

      function loadYear(year) {
        clearAllLayers();
        let globalBounds = null;
        let pending = 0;

        blocks.forEach((block) => {
          ["added", "disappeared", "persisted", "historical_all"].forEach(
            (type) => {
              const url = `./melway_outputs/${year}/${block}/${type}.geojson`;
              pending++;

              fetch(url)
                .then((res) => res.json())
                .then((data) => {
                  let layer = L.geoJSON(data, {
                    style: { color: layerColors[type], weight: 2 },
                  });

                  layerGroups[type].push(layer);
                  layer.addTo(map);

                  let bounds = layer.getBounds();
                  if (bounds.isValid()) {
                    globalBounds = globalBounds
                      ? globalBounds.extend(bounds)
                      : bounds;
                  }
                })
                .catch(() => {})
                .finally(() => {
                  pending--;
                  if (pending === 0 && globalBounds) {
                    map.fitBounds(globalBounds, { padding: [20, 20] });
                  }
                });
            }
          );
        });
      }

      /* ===============================
   Toggle Historical Layer
================================== */

      document
        .getElementById("toggleHistorical")
        .addEventListener("change", function () {
          if (this.checked) {
            layerGroups["historical_all"].forEach((layer) =>
              map.addLayer(layer)
            );
          } else {
            layerGroups["historical_all"].forEach((layer) =>
              map.removeLayer(layer)
            );
          }
        });

      /* ===============================
   建立年份按鈕
================================== */

      const btnGroup = document.getElementById("yearButtons");

      years.forEach((yr, idx) => {
        let btn = document.createElement("button");
        btn.className = "btn btn-outline-primary";
        if (idx === 0) btn.classList.add("active");
        btn.innerText = yr;

        btn.addEventListener("click", function () {
          document
            .querySelectorAll("#yearButtons button")
            .forEach((b) => b.classList.remove("active"));
          this.classList.add("active");
          loadYear(yr);
        });

        btnGroup.appendChild(btn);
      });

      /* ===============================
   初始載入
================================== */
      loadYear(years[0]);
    </script>
  </body>
</html>
